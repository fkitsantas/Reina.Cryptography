<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Reina.Cryptography: Reina.Cryptography.KeyManagement.AzureKVKeyManager Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Reina.Cryptography
   </div>
   <div id="projectbrief">About</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespace_reina.html">Reina</a></li><li class="navelem"><a class="el" href="namespace_reina_1_1_cryptography.html">Cryptography</a></li><li class="navelem"><a class="el" href="namespace_reina_1_1_cryptography_1_1_key_management.html">KeyManagement</a></li><li class="navelem"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html">AzureKVKeyManager</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#properties">Properties</a> &#124;
<a href="#pri-methods">Private Member Functions</a> &#124;
<a href="#pri-attribs">Private Attributes</a> &#124;
<a href="#pri-static-attribs">Static Private Attributes</a> &#124;
<a href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">Reina.Cryptography.KeyManagement.AzureKVKeyManager Class Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Manages 256-bit cryptographic keys by interfacing with Azure Key Vault, providing secure storage and retrieval of keys. This class implements a caching mechanism to optimize key retrieval performance by reducing the number of round trips to the key vault.  
 <a href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#details">More...</a></p>
<div class="dynheader">
Inheritance diagram for Reina.Cryptography.KeyManagement.AzureKVKeyManager:</div>
<div class="dyncontent">
<div class="center"><img src="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager__inherit__graph.png" border="0" usemap="#a_reina_8_cryptography_8_key_management_8_azure_k_v_key_manager_inherit__map" alt="Inheritance graph"/></div>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for Reina.Cryptography.KeyManagement.AzureKVKeyManager:</div>
<div class="dyncontent">
<div class="center"><img src="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager__coll__graph.png" border="0" usemap="#a_reina_8_cryptography_8_key_management_8_azure_k_v_key_manager_coll__map" alt="Collaboration graph"/></div>
<center><span class="legend">[<a href="graph_legend.html">legend</a>]</span></center></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:af5aaf547ee232991879a67abc406a492" id="r_af5aaf547ee232991879a67abc406a492"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#af5aaf547ee232991879a67abc406a492">AzureKVKeyManager</a> (string vaultUri, string clientId, string clientSecret, string tenantId)</td></tr>
<tr class="memdesc:af5aaf547ee232991879a67abc406a492"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes a new instance of the AzureKVKeyManager class.  <br /></td></tr>
<tr class="separator:af5aaf547ee232991879a67abc406a492"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8cc7bef1fdb0aba8eb4bab50d5cbb023" id="r_a8cc7bef1fdb0aba8eb4bab50d5cbb023"><td class="memItemLeft" align="right" valign="top">async Task&lt; byte[]&gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a8cc7bef1fdb0aba8eb4bab50d5cbb023">GetEncryptionKeyAsync</a> (string baseKeyName)</td></tr>
<tr class="memdesc:a8cc7bef1fdb0aba8eb4bab50d5cbb023"><td class="mdescLeft">&#160;</td><td class="mdescRight">Asynchronously retrieves an encryption key from Azure Key Vault or the local cache.  <br /></td></tr>
<tr class="separator:a8cc7bef1fdb0aba8eb4bab50d5cbb023"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a75fbfb0eb22d28ccb97d25dda48a9abf" id="r_a75fbfb0eb22d28ccb97d25dda48a9abf"><td class="memItemLeft" align="right" valign="top">async Task&lt; List&lt; byte[]&gt; &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a75fbfb0eb22d28ccb97d25dda48a9abf">GetDecryptionKeysAsync</a> (string baseKeyName)</td></tr>
<tr class="memdesc:a75fbfb0eb22d28ccb97d25dda48a9abf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Asynchronously retrieves an encryption key from Azure Key Vault or the local cache.  <br /></td></tr>
<tr class="separator:a75fbfb0eb22d28ccb97d25dda48a9abf"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="properties" name="properties"></a>
Properties</h2></td></tr>
<tr class="memitem:a01998e93a45999d7071c149fef32390f" id="r_a01998e93a45999d7071c149fef32390f"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html">AzureKVKeyManager</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a01998e93a45999d7071c149fef32390f">Instance</a><code> [get]</code></td></tr>
<tr class="memdesc:a01998e93a45999d7071c149fef32390f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets the singleton instance of the AzureKVKeyManager.  <br /></td></tr>
<tr class="separator:a01998e93a45999d7071c149fef32390f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-methods" name="pri-methods"></a>
Private Member Functions</h2></td></tr>
<tr class="memitem:abca540502dc71b012ede463584bf63f2" id="r_abca540502dc71b012ede463584bf63f2"><td class="memItemLeft" align="right" valign="top">async Task&lt;(string versionedName, byte[] key)&gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#abca540502dc71b012ede463584bf63f2">EnsureRotatedKeyAsync</a> (string baseKeyName)</td></tr>
<tr class="memdesc:abca540502dc71b012ede463584bf63f2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Ensures that a cryptographic key is present and rotated if necessary based on the configured threshold. If no key exists, it creates the initial version. If the latest version is older than the rotation threshold, it creates a new version. Also cleans up versions older than the configured retention period.  <br /></td></tr>
<tr class="separator:abca540502dc71b012ede463584bf63f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa6d24f34039e3f3a396f2d00c5beeaaa" id="r_aa6d24f34039e3f3a396f2d00c5beeaaa"><td class="memItemLeft" align="right" valign="top">byte[]&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aa6d24f34039e3f3a396f2d00c5beeaaa">Generate256bitKey</a> ()</td></tr>
<tr class="memdesc:aa6d24f34039e3f3a396f2d00c5beeaaa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Generates a new 256-bit cryptographic key.  <br /></td></tr>
<tr class="separator:aa6d24f34039e3f3a396f2d00c5beeaaa"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-attribs" name="pri-attribs"></a>
Private Attributes</h2></td></tr>
<tr class="memitem:a0f0d684424e6f369769493e5d9023cf3" id="r_a0f0d684424e6f369769493e5d9023cf3"><td class="memItemLeft" align="right" valign="top">readonly SecretClient&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">_secretClient</a></td></tr>
<tr class="separator:a0f0d684424e6f369769493e5d9023cf3"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-static-attribs" name="pri-static-attribs"></a>
Static Private Attributes</h2></td></tr>
<tr class="memitem:aea9ba4e47b0fd2657081a1bc4767f73d" id="r_aea9ba4e47b0fd2657081a1bc4767f73d"><td class="memItemLeft" align="right" valign="top">static readonly ConcurrentDictionary&lt; string, byte[]&gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aea9ba4e47b0fd2657081a1bc4767f73d">_keyCache</a> = new()</td></tr>
<tr class="separator:aea9ba4e47b0fd2657081a1bc4767f73d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4dc18ecb50932bc8a02d7dedfcf946ee" id="r_a4dc18ecb50932bc8a02d7dedfcf946ee"><td class="memItemLeft" align="right" valign="top">static readonly Lazy&lt; <a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html">AzureKVKeyManager</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a4dc18ecb50932bc8a02d7dedfcf946ee">_instance</a></td></tr>
<tr class="separator:a4dc18ecb50932bc8a02d7dedfcf946ee"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Manages 256-bit cryptographic keys by interfacing with Azure Key Vault, providing secure storage and retrieval of keys. This class implements a caching mechanism to optimize key retrieval performance by reducing the number of round trips to the key vault. </p>

<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00018">18</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="af5aaf547ee232991879a67abc406a492" name="af5aaf547ee232991879a67abc406a492"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af5aaf547ee232991879a67abc406a492">&#9670;&#160;</a></span>AzureKVKeyManager()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">Reina.Cryptography.KeyManagement.AzureKVKeyManager.AzureKVKeyManager </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>vaultUri</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>clientId</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>clientSecret</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>tenantId</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initializes a new instance of the AzureKVKeyManager class. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">vaultUri</td><td>The URI of the Azure Key Vault.</td></tr>
    <tr><td class="paramname">clientId</td><td>The client ID for Azure Active Directory authentication.</td></tr>
    <tr><td class="paramname">clientSecret</td><td>The client secret for Azure Active Directory authentication.</td></tr>
    <tr><td class="paramname">tenantId</td><td>The tenant ID for Azure Active Directory authentication.</td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00047">47</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   48</span>        {</div>
<div class="line"><span class="lineno">   49</span>            var clientOptions = <span class="keyword">new</span> SecretClientOptions</div>
<div class="line"><span class="lineno">   50</span>            {</div>
<div class="line"><span class="lineno">   51</span>                Retry =</div>
<div class="line"><span class="lineno">   52</span>                {</div>
<div class="line"><span class="lineno">   53</span>                    Delay = TimeSpan.FromSeconds(1),</div>
<div class="line"><span class="lineno">   54</span>                    MaxDelay = TimeSpan.FromSeconds(10),</div>
<div class="line"><span class="lineno">   55</span>                    MaxRetries = 5,</div>
<div class="line"><span class="lineno">   56</span>                    Mode = RetryMode.Exponential</div>
<div class="line"><span class="lineno">   57</span>                }</div>
<div class="line"><span class="lineno">   58</span>            };</div>
<div class="line"><span class="lineno">   59</span> </div>
<div class="line"><span class="lineno">   60</span>            var credential = <span class="keyword">new</span> ClientSecretCredential(tenantId, clientId, clientSecret);</div>
<div class="line"><span class="lineno">   61</span>            <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">_secretClient</a> = <span class="keyword">new</span> SecretClient(<span class="keyword">new</span> Uri(vaultUri), credential, clientOptions);</div>
<div class="line"><span class="lineno">   62</span>        }</div>
<div class="ttc" id="aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_html_a0f0d684424e6f369769493e5d9023cf3"><div class="ttname"><a href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">Reina.Cryptography.KeyManagement.AzureKVKeyManager._secretClient</a></div><div class="ttdeci">readonly SecretClient _secretClient</div><div class="ttdef"><b>Definition</b> <a href="_azure_k_v_key_manager_8cs_source.html#l00020">AzureKVKeyManager.cs:20</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00020">Reina.Cryptography.KeyManagement.AzureKVKeyManager._secretClient</a>.</p>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="abca540502dc71b012ede463584bf63f2" name="abca540502dc71b012ede463584bf63f2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abca540502dc71b012ede463584bf63f2">&#9670;&#160;</a></span>EnsureRotatedKeyAsync()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">async Task&lt;(string versionedName, byte[] key)&gt; Reina.Cryptography.KeyManagement.AzureKVKeyManager.EnsureRotatedKeyAsync </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>baseKeyName</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Ensures that a cryptographic key is present and rotated if necessary based on the configured threshold. If no key exists, it creates the initial version. If the latest version is older than the rotation threshold, it creates a new version. Also cleans up versions older than the configured retention period. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">baseKeyName</td><td>The base name of the key (without version suffix).</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>A tuple containing the versioned key name and the associated 256-bit key as a byte array. </dd></dl>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">UnauthorizedAccessException</td><td>Thrown when authentication or authorization with Azure Key Vault fails. </td></tr>
    <tr><td class="paramname">Exception</td><td>Thrown when an error occurs during the retrieval, creation, or rotation of secrets. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00191">191</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  192</span>        {</div>
<div class="line"><span class="lineno">  193</span>            <span class="keywordflow">try</span></div>
<div class="line"><span class="lineno">  194</span>            {</div>
<div class="line"><span class="lineno">  195</span>                var cfg = <a class="code hl_class" href="class_reina_1_1_cryptography_1_1_configuration_1_1_config.html">Config</a>.<a class="code hl_property" href="class_reina_1_1_cryptography_1_1_configuration_1_1_config.html#ad172cb33a6967cf148ed21bd2e6383ea">Instance</a>;</div>
<div class="line"><span class="lineno">  196</span>                var versionPattern = <span class="keyword">new</span> Regex($<span class="stringliteral">&quot;^{Regex.Escape(baseKeyName)}--v(\\d+)$&quot;</span>, RegexOptions.Compiled);</div>
<div class="line"><span class="lineno">  197</span>                var versions = <span class="keyword">new</span> List&lt;(int, SecretProperties)&gt;();</div>
<div class="line"><span class="lineno">  198</span> </div>
<div class="line"><span class="lineno">  199</span>                await <span class="keywordflow">foreach</span> (var prop <span class="keywordflow">in</span> <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">_secretClient</a>.GetPropertiesOfSecretsAsync())</div>
<div class="line"><span class="lineno">  200</span>                {</div>
<div class="line"><span class="lineno">  201</span>                    var match = versionPattern.Match(prop.Name);</div>
<div class="line"><span class="lineno">  202</span>                    <span class="keywordflow">if</span> (match.Success &amp;&amp; <span class="keywordtype">int</span>.TryParse(match.Groups[1].Value, out <span class="keywordtype">int</span> version))</div>
<div class="line"><span class="lineno">  203</span>                        versions.Add((version, prop));</div>
<div class="line"><span class="lineno">  204</span>                }</div>
<div class="line"><span class="lineno">  205</span> </div>
<div class="line"><span class="lineno">  206</span>                <span class="keywordflow">if</span> (versions.Count == 0)</div>
<div class="line"><span class="lineno">  207</span>                {</div>
<div class="line"><span class="lineno">  208</span>                    <span class="keywordtype">string</span> name = $<span class="stringliteral">&quot;{baseKeyName}--v1&quot;</span>;</div>
<div class="line"><span class="lineno">  209</span>                    <span class="keywordtype">byte</span>[] key = <a class="code hl_function" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aa6d24f34039e3f3a396f2d00c5beeaaa">Generate256bitKey</a>();</div>
<div class="line"><span class="lineno">  210</span>                    await <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">_secretClient</a>.SetSecretAsync(name, Convert.ToBase64String(key)).ConfigureAwait(<span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  211</span>                    <span class="keywordflow">return</span> (name, key);</div>
<div class="line"><span class="lineno">  212</span>                }</div>
<div class="line"><span class="lineno">  213</span> </div>
<div class="line"><span class="lineno">  214</span>                var sorted = versions.OrderByDescending(v =&gt; v.Item1).ToList();</div>
<div class="line"><span class="lineno">  215</span>                var (latestVersion, latestProp) = sorted.First();</div>
<div class="line"><span class="lineno">  216</span>                var created = latestProp.CreatedOn ?? DateTimeOffset.UtcNow;</div>
<div class="line"><span class="lineno">  217</span> </div>
<div class="line"><span class="lineno">  218</span>                <span class="keywordflow">if</span> (created.Add(cfg.KeyRotationThreshold) &lt;= DateTimeOffset.UtcNow)</div>
<div class="line"><span class="lineno">  219</span>                {</div>
<div class="line"><span class="lineno">  220</span>                    <span class="keywordtype">int</span> newVersion = latestVersion + 1;</div>
<div class="line"><span class="lineno">  221</span>                    <span class="keywordtype">string</span> name = $<span class="stringliteral">&quot;{baseKeyName}--v{newVersion}&quot;</span>;</div>
<div class="line"><span class="lineno">  222</span>                    <span class="keywordtype">byte</span>[] key = <a class="code hl_function" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aa6d24f34039e3f3a396f2d00c5beeaaa">Generate256bitKey</a>();</div>
<div class="line"><span class="lineno">  223</span>                    await <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">_secretClient</a>.SetSecretAsync(name, Convert.ToBase64String(key)).ConfigureAwait(<span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  224</span> </div>
<div class="line"><span class="lineno">  225</span>                    var cutoff = DateTimeOffset.UtcNow.Subtract(cfg.KeyRetentionPeriod);</div>
<div class="line"><span class="lineno">  226</span>                    <span class="keywordflow">foreach</span> (var (_, prop) in sorted)</div>
<div class="line"><span class="lineno">  227</span>                    {</div>
<div class="line"><span class="lineno">  228</span>                        <span class="keywordflow">if</span> ((prop.CreatedOn ?? DateTimeOffset.UtcNow) &lt; cutoff)</div>
<div class="line"><span class="lineno">  229</span>                            <span class="keywordflow">try</span> { await <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">_secretClient</a>.StartDeleteSecretAsync(prop.Name).ConfigureAwait(<span class="keyword">false</span>); } <span class="keywordflow">catch</span> { }</div>
<div class="line"><span class="lineno">  230</span>                    }</div>
<div class="line"><span class="lineno">  231</span> </div>
<div class="line"><span class="lineno">  232</span>                    <span class="keywordflow">return</span> (name, key);</div>
<div class="line"><span class="lineno">  233</span>                }</div>
<div class="line"><span class="lineno">  234</span>                <span class="keywordflow">else</span></div>
<div class="line"><span class="lineno">  235</span>                {</div>
<div class="line"><span class="lineno">  236</span>                    var secret = await <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">_secretClient</a>.GetSecretAsync(latestProp.Name);</div>
<div class="line"><span class="lineno">  237</span>                    <span class="keywordflow">return</span> (latestProp.Name, Convert.FromBase64String(secret.Value.Value));</div>
<div class="line"><span class="lineno">  238</span>                }</div>
<div class="line"><span class="lineno">  239</span>            }</div>
<div class="line"><span class="lineno">  240</span>            <span class="keywordflow">catch</span> (Azure.RequestFailedException ex) when (ex.Status == 401)</div>
<div class="line"><span class="lineno">  241</span>            {</div>
<div class="line"><span class="lineno">  242</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> UnauthorizedAccessException(<span class="stringliteral">&quot;Failed to authenticate with Azure Key Vault. Check credentials.&quot;</span>, ex);</div>
<div class="line"><span class="lineno">  243</span>            }</div>
<div class="line"><span class="lineno">  244</span>            <span class="keywordflow">catch</span> (Azure.RequestFailedException ex) when (ex.Status == 403)</div>
<div class="line"><span class="lineno">  245</span>            {</div>
<div class="line"><span class="lineno">  246</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> UnauthorizedAccessException(<span class="stringliteral">&quot;Access denied. Check Key Vault permissions.&quot;</span>, ex);</div>
<div class="line"><span class="lineno">  247</span>            }</div>
<div class="line"><span class="lineno">  248</span>            <span class="keywordflow">catch</span> (Azure.RequestFailedException ex)</div>
<div class="line"><span class="lineno">  249</span>            {</div>
<div class="line"><span class="lineno">  250</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($<span class="stringliteral">&quot;Azure Key Vault error: {ex.Message}&quot;</span>, ex);</div>
<div class="line"><span class="lineno">  251</span>            }</div>
<div class="line"><span class="lineno">  252</span>            <span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line"><span class="lineno">  253</span>            {</div>
<div class="line"><span class="lineno">  254</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($<span class="stringliteral">&quot;Unexpected error in EnsureRotatedKeyAsync: {ex.Message}&quot;</span>, ex);</div>
<div class="line"><span class="lineno">  255</span>            }</div>
<div class="line"><span class="lineno">  256</span>        }</div>
<div class="ttc" id="aclass_reina_1_1_cryptography_1_1_configuration_1_1_config_html"><div class="ttname"><a href="class_reina_1_1_cryptography_1_1_configuration_1_1_config.html">Reina.Cryptography.Configuration.Config</a></div><div class="ttdoc">Represents the configuration settings for accessing Azure Key Vault. This class follows the Singleton...</div><div class="ttdef"><b>Definition</b> <a href="_config_8cs_source.html#l00010">Config.cs:11</a></div></div>
<div class="ttc" id="aclass_reina_1_1_cryptography_1_1_configuration_1_1_config_html_ad172cb33a6967cf148ed21bd2e6383ea"><div class="ttname"><a href="class_reina_1_1_cryptography_1_1_configuration_1_1_config.html#ad172cb33a6967cf148ed21bd2e6383ea">Reina.Cryptography.Configuration.Config.Instance</a></div><div class="ttdeci">static Config Instance</div><div class="ttdoc">Provides global access to the singleton instance of the configuration.</div><div class="ttdef"><b>Definition</b> <a href="_config_8cs_source.html#l00025">Config.cs:25</a></div></div>
<div class="ttc" id="aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_html_aa6d24f34039e3f3a396f2d00c5beeaaa"><div class="ttname"><a href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aa6d24f34039e3f3a396f2d00c5beeaaa">Reina.Cryptography.KeyManagement.AzureKVKeyManager.Generate256bitKey</a></div><div class="ttdeci">byte[] Generate256bitKey()</div><div class="ttdoc">Generates a new 256-bit cryptographic key.</div><div class="ttdef"><b>Definition</b> <a href="_azure_k_v_key_manager_8cs_source.html#l00262">AzureKVKeyManager.cs:262</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00020">Reina.Cryptography.KeyManagement.AzureKVKeyManager._secretClient</a>, <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00262">Reina.Cryptography.KeyManagement.AzureKVKeyManager.Generate256bitKey()</a>, and <a class="el" href="_config_8cs_source.html#l00025">Reina.Cryptography.Configuration.Config.Instance</a>.</p>

<p class="reference">Referenced by <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00108">Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetDecryptionKeysAsync()</a>, and <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00071">Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetEncryptionKeyAsync()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_abca540502dc71b012ede463584bf63f2_cgraph.png" border="0" usemap="#aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_abca540502dc71b012ede463584bf63f2_cgraph" alt=""/></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_abca540502dc71b012ede463584bf63f2_icgraph.png" border="0" usemap="#aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_abca540502dc71b012ede463584bf63f2_icgraph" alt=""/></div>
</div>

</div>
</div>
<a id="aa6d24f34039e3f3a396f2d00c5beeaaa" name="aa6d24f34039e3f3a396f2d00c5beeaaa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa6d24f34039e3f3a396f2d00c5beeaaa">&#9670;&#160;</a></span>Generate256bitKey()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">byte[] Reina.Cryptography.KeyManagement.AzureKVKeyManager.Generate256bitKey </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Generates a new 256-bit cryptographic key. </p>
<dl class="section return"><dt>Returns</dt><dd>A byte array containing the generated key.</dd></dl>

<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00262">262</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  263</span>        {</div>
<div class="line"><span class="lineno">  264</span>            <span class="keyword">using </span>var aesAlg = Aes.Create();</div>
<div class="line"><span class="lineno">  265</span>            aesAlg.KeySize = 256;</div>
<div class="line"><span class="lineno">  266</span>            aesAlg.GenerateKey();</div>
<div class="line"><span class="lineno">  267</span>            <span class="keywordflow">return</span> aesAlg.Key;</div>
<div class="line"><span class="lineno">  268</span>        }</div>
</div><!-- fragment -->
<p class="reference">Referenced by <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00191">Reina.Cryptography.KeyManagement.AzureKVKeyManager.EnsureRotatedKeyAsync()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_aa6d24f34039e3f3a396f2d00c5beeaaa_icgraph.png" border="0" usemap="#aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_aa6d24f34039e3f3a396f2d00c5beeaaa_icgraph" alt=""/></div>
</div>

</div>
</div>
<a id="a75fbfb0eb22d28ccb97d25dda48a9abf" name="a75fbfb0eb22d28ccb97d25dda48a9abf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a75fbfb0eb22d28ccb97d25dda48a9abf">&#9670;&#160;</a></span>GetDecryptionKeysAsync()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">async Task&lt; List&lt; byte[]&gt; &gt; Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetDecryptionKeysAsync </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>baseKeyName</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Asynchronously retrieves an encryption key from Azure Key Vault or the local cache. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">baseKeyName</td><td>The base name of the key to retrieve (without version suffix).</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>A byte array containing the encryption key.</dd></dl>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">UnauthorizedAccessException</td><td>Thrown when authentication or authorization with Azure Key Vault fails.</td></tr>
    <tr><td class="paramname">Exception</td><td>Thrown when an unexpected error occurs during key retrieval or generation.</td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00108">108</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  109</span>        {</div>
<div class="line"><span class="lineno">  110</span>            var cfg = <a class="code hl_class" href="class_reina_1_1_cryptography_1_1_configuration_1_1_config.html">Config</a>.<a class="code hl_property" href="class_reina_1_1_cryptography_1_1_configuration_1_1_config.html#ad172cb33a6967cf148ed21bd2e6383ea">Instance</a>;</div>
<div class="line"><span class="lineno">  111</span>            var versionPattern = <span class="keyword">new</span> Regex($<span class="stringliteral">&quot;^{Regex.Escape(baseKeyName)}--v(\\d+)$&quot;</span>, RegexOptions.Compiled);</div>
<div class="line"><span class="lineno">  112</span>            var versions = <span class="keyword">new</span> List&lt;(int Version, SecretProperties Props)&gt;();</div>
<div class="line"><span class="lineno">  113</span> </div>
<div class="line"><span class="lineno">  114</span>            <span class="keywordflow">try</span></div>
<div class="line"><span class="lineno">  115</span>            {</div>
<div class="line"><span class="lineno">  116</span>                await <span class="keywordflow">foreach</span> (var prop <span class="keywordflow">in</span> <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">_secretClient</a>.GetPropertiesOfSecretsAsync().ConfigureAwait(<span class="keyword">false</span>))</div>
<div class="line"><span class="lineno">  117</span>                {</div>
<div class="line"><span class="lineno">  118</span>                    var match = versionPattern.Match(prop.Name);</div>
<div class="line"><span class="lineno">  119</span>                    <span class="keywordflow">if</span> (match.Success &amp;&amp; <span class="keywordtype">int</span>.TryParse(match.Groups[1].Value, out <span class="keywordtype">int</span> version))</div>
<div class="line"><span class="lineno">  120</span>                        versions.Add((version, prop));</div>
<div class="line"><span class="lineno">  121</span>                }</div>
<div class="line"><span class="lineno">  122</span> </div>
<div class="line"><span class="lineno">  123</span>                <span class="keywordflow">if</span> (versions.Count == 0)</div>
<div class="line"><span class="lineno">  124</span>                {</div>
<div class="line"><span class="lineno">  125</span>                    var freshKey = await <a class="code hl_function" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a8cc7bef1fdb0aba8eb4bab50d5cbb023">GetEncryptionKeyAsync</a>(baseKeyName).ConfigureAwait(<span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  126</span>                    <span class="keywordflow">return</span> <span class="keyword">new</span> List&lt;byte[]&gt; { freshKey };</div>
<div class="line"><span class="lineno">  127</span>                }</div>
<div class="line"><span class="lineno">  128</span> </div>
<div class="line"><span class="lineno">  129</span>                var sorted = versions.OrderByDescending(v =&gt; v.Version).ToList();</div>
<div class="line"><span class="lineno">  130</span>                var keys = <span class="keyword">new</span> List&lt;byte[]&gt;();</div>
<div class="line"><span class="lineno">  131</span> </div>
<div class="line"><span class="lineno">  132</span>                <span class="keywordflow">foreach</span> (var (v, prop) in sorted)</div>
<div class="line"><span class="lineno">  133</span>                {</div>
<div class="line"><span class="lineno">  134</span>                    <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aea9ba4e47b0fd2657081a1bc4767f73d">_keyCache</a>.TryGetValue(prop.Name, out var cached))</div>
<div class="line"><span class="lineno">  135</span>                    {</div>
<div class="line"><span class="lineno">  136</span>                        keys.Add(cached);</div>
<div class="line"><span class="lineno">  137</span>                        <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  138</span>                    }</div>
<div class="line"><span class="lineno">  139</span> </div>
<div class="line"><span class="lineno">  140</span>                    <span class="keywordflow">try</span></div>
<div class="line"><span class="lineno">  141</span>                    {</div>
<div class="line"><span class="lineno">  142</span>                        var secret = (await <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a0f0d684424e6f369769493e5d9023cf3">_secretClient</a>.GetSecretAsync(prop.Name).ConfigureAwait(<span class="keyword">false</span>)).Value;</div>
<div class="line"><span class="lineno">  143</span>                        var key = Convert.FromBase64String(secret.Value);</div>
<div class="line"><span class="lineno">  144</span>                        <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aea9ba4e47b0fd2657081a1bc4767f73d">_keyCache</a>[prop.Name] = key;</div>
<div class="line"><span class="lineno">  145</span>                        keys.Add(key);</div>
<div class="line"><span class="lineno">  146</span>                    }</div>
<div class="line"><span class="lineno">  147</span>                    <span class="keywordflow">catch</span></div>
<div class="line"><span class="lineno">  148</span>                    {</div>
<div class="line"><span class="lineno">  149</span>                        <span class="comment">// Ignore and skip missing/invalid secrets</span></div>
<div class="line"><span class="lineno">  150</span>                    }</div>
<div class="line"><span class="lineno">  151</span>                }</div>
<div class="line"><span class="lineno">  152</span> </div>
<div class="line"><span class="lineno">  153</span>                <span class="comment">// Ensure rotation during decryption flow</span></div>
<div class="line"><span class="lineno">  154</span>                await <a class="code hl_function" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#abca540502dc71b012ede463584bf63f2">EnsureRotatedKeyAsync</a>(baseKeyName).ConfigureAwait(<span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">  155</span> </div>
<div class="line"><span class="lineno">  156</span>                <span class="keywordflow">return</span> keys;</div>
<div class="line"><span class="lineno">  157</span>            }</div>
<div class="line"><span class="lineno">  158</span>            <span class="keywordflow">catch</span> (Azure.RequestFailedException ex) when (ex.Status == 401)</div>
<div class="line"><span class="lineno">  159</span>            {</div>
<div class="line"><span class="lineno">  160</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> UnauthorizedAccessException(<span class="stringliteral">&quot;Failed to authenticate with Azure Key Vault. Please check your credentials.&quot;</span>, ex);</div>
<div class="line"><span class="lineno">  161</span>            }</div>
<div class="line"><span class="lineno">  162</span>            <span class="keywordflow">catch</span> (Azure.RequestFailedException ex) when (ex.Status == 403)</div>
<div class="line"><span class="lineno">  163</span>            {</div>
<div class="line"><span class="lineno">  164</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> UnauthorizedAccessException(<span class="stringliteral">&quot;Access denied. The application does not have the necessary permissions to access the Azure Key Vault secret.&quot;</span>, ex);</div>
<div class="line"><span class="lineno">  165</span>            }</div>
<div class="line"><span class="lineno">  166</span>            <span class="keywordflow">catch</span> (Azure.RequestFailedException ex)</div>
<div class="line"><span class="lineno">  167</span>            {</div>
<div class="line"><span class="lineno">  168</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($<span class="stringliteral">&quot;An error occurred while accessing Azure Key Vault: {ex.Message}&quot;</span>, ex);</div>
<div class="line"><span class="lineno">  169</span>            }</div>
<div class="line"><span class="lineno">  170</span>            <span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line"><span class="lineno">  171</span>            {</div>
<div class="line"><span class="lineno">  172</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($<span class="stringliteral">&quot;An unexpected error occurred: {ex.Message}&quot;</span>, ex);</div>
<div class="line"><span class="lineno">  173</span>            }</div>
<div class="line"><span class="lineno">  174</span>        }</div>
<div class="ttc" id="aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_html_a8cc7bef1fdb0aba8eb4bab50d5cbb023"><div class="ttname"><a href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#a8cc7bef1fdb0aba8eb4bab50d5cbb023">Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetEncryptionKeyAsync</a></div><div class="ttdeci">async Task&lt; byte[]&gt; GetEncryptionKeyAsync(string baseKeyName)</div><div class="ttdoc">Asynchronously retrieves an encryption key from Azure Key Vault or the local cache.</div><div class="ttdef"><b>Definition</b> <a href="_azure_k_v_key_manager_8cs_source.html#l00071">AzureKVKeyManager.cs:71</a></div></div>
<div class="ttc" id="aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_html_abca540502dc71b012ede463584bf63f2"><div class="ttname"><a href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#abca540502dc71b012ede463584bf63f2">Reina.Cryptography.KeyManagement.AzureKVKeyManager.EnsureRotatedKeyAsync</a></div><div class="ttdeci">async Task&lt;(string versionedName, byte[] key)&gt; EnsureRotatedKeyAsync(string baseKeyName)</div><div class="ttdoc">Ensures that a cryptographic key is present and rotated if necessary based on the configured threshol...</div><div class="ttdef"><b>Definition</b> <a href="_azure_k_v_key_manager_8cs_source.html#l00191">AzureKVKeyManager.cs:191</a></div></div>
<div class="ttc" id="aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_html_aea9ba4e47b0fd2657081a1bc4767f73d"><div class="ttname"><a href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aea9ba4e47b0fd2657081a1bc4767f73d">Reina.Cryptography.KeyManagement.AzureKVKeyManager._keyCache</a></div><div class="ttdeci">static readonly ConcurrentDictionary&lt; string, byte[]&gt; _keyCache</div><div class="ttdef"><b>Definition</b> <a href="_azure_k_v_key_manager_8cs_source.html#l00021">AzureKVKeyManager.cs:21</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00021">Reina.Cryptography.KeyManagement.AzureKVKeyManager._keyCache</a>, <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00020">Reina.Cryptography.KeyManagement.AzureKVKeyManager._secretClient</a>, <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00191">Reina.Cryptography.KeyManagement.AzureKVKeyManager.EnsureRotatedKeyAsync()</a>, <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00071">Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetEncryptionKeyAsync()</a>, and <a class="el" href="_config_8cs_source.html#l00025">Reina.Cryptography.Configuration.Config.Instance</a>.</p>

<p class="reference">Referenced by <a class="el" href="_library_8cs_source.html#l00086">Reina.Cryptography.Library.Decrypt()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_a75fbfb0eb22d28ccb97d25dda48a9abf_cgraph.png" border="0" usemap="#aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_a75fbfb0eb22d28ccb97d25dda48a9abf_cgraph" alt=""/></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_a75fbfb0eb22d28ccb97d25dda48a9abf_icgraph.png" border="0" usemap="#aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_a75fbfb0eb22d28ccb97d25dda48a9abf_icgraph" alt=""/></div>
</div>

</div>
</div>
<a id="a8cc7bef1fdb0aba8eb4bab50d5cbb023" name="a8cc7bef1fdb0aba8eb4bab50d5cbb023"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8cc7bef1fdb0aba8eb4bab50d5cbb023">&#9670;&#160;</a></span>GetEncryptionKeyAsync()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">async Task&lt; byte[]&gt; Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetEncryptionKeyAsync </td>
          <td>(</td>
          <td class="paramtype">string&#160;</td>
          <td class="paramname"><em>baseKeyName</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Asynchronously retrieves an encryption key from Azure Key Vault or the local cache. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">baseKeyName</td><td>The name of the key to retrieve.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>A byte array containing the encryption key.</dd></dl>
<dl class="exception"><dt>Exceptions</dt><dd>
  <table class="exception">
    <tr><td class="paramname">UnauthorizedAccessException</td><td>Thrown when authentication or authorization with Azure Key Vault fails.</td></tr>
    <tr><td class="paramname">Exception</td><td>Thrown when an unexpected error occurs during key retrieval or generation.</td></tr>
  </table>
  </dd>
</dl>

<p>Implements <a class="el" href="interface_reina_1_1_cryptography_1_1_interfaces_1_1_i_key_manager.html#a5e9ab1843897162752920da2ab7778c7">Reina.Cryptography.Interfaces.IKeyManager</a>.</p>

<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00071">71</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   72</span>        {</div>
<div class="line"><span class="lineno">   73</span>            <span class="keywordflow">try</span></div>
<div class="line"><span class="lineno">   74</span>            {</div>
<div class="line"><span class="lineno">   75</span>                <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aea9ba4e47b0fd2657081a1bc4767f73d">_keyCache</a>.TryGetValue(baseKeyName, out var cachedKey))</div>
<div class="line"><span class="lineno">   76</span>                    <span class="keywordflow">return</span> cachedKey;</div>
<div class="line"><span class="lineno">   77</span> </div>
<div class="line"><span class="lineno">   78</span>                var (versionedName, key) = await <a class="code hl_function" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#abca540502dc71b012ede463584bf63f2">EnsureRotatedKeyAsync</a>(baseKeyName).ConfigureAwait(<span class="keyword">false</span>);</div>
<div class="line"><span class="lineno">   79</span>                <a class="code hl_variable" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#aea9ba4e47b0fd2657081a1bc4767f73d">_keyCache</a>[baseKeyName] = key;</div>
<div class="line"><span class="lineno">   80</span>                <span class="keywordflow">return</span> key;</div>
<div class="line"><span class="lineno">   81</span>            }</div>
<div class="line"><span class="lineno">   82</span>            <span class="keywordflow">catch</span> (Azure.RequestFailedException ex) when (ex.Status == 401)</div>
<div class="line"><span class="lineno">   83</span>            {</div>
<div class="line"><span class="lineno">   84</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> UnauthorizedAccessException(<span class="stringliteral">&quot;Failed to authenticate with Azure Key Vault. Check credentials.&quot;</span>, ex);</div>
<div class="line"><span class="lineno">   85</span>            }</div>
<div class="line"><span class="lineno">   86</span>            <span class="keywordflow">catch</span> (Azure.RequestFailedException ex) when (ex.Status == 403)</div>
<div class="line"><span class="lineno">   87</span>            {</div>
<div class="line"><span class="lineno">   88</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> UnauthorizedAccessException(<span class="stringliteral">&quot;Access denied. Check Key Vault permissions.&quot;</span>, ex);</div>
<div class="line"><span class="lineno">   89</span>            }</div>
<div class="line"><span class="lineno">   90</span>            <span class="keywordflow">catch</span> (Azure.RequestFailedException ex)</div>
<div class="line"><span class="lineno">   91</span>            {</div>
<div class="line"><span class="lineno">   92</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($<span class="stringliteral">&quot;Azure Key Vault error: {ex.Message}&quot;</span>, ex);</div>
<div class="line"><span class="lineno">   93</span>            }</div>
<div class="line"><span class="lineno">   94</span>            <span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line"><span class="lineno">   95</span>            {</div>
<div class="line"><span class="lineno">   96</span>                <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception($<span class="stringliteral">&quot;Unexpected error in GetEncryptionKeyAsync: {ex.Message}&quot;</span>, ex);</div>
<div class="line"><span class="lineno">   97</span>            }</div>
<div class="line"><span class="lineno">   98</span>        }</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00021">Reina.Cryptography.KeyManagement.AzureKVKeyManager._keyCache</a>, and <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00191">Reina.Cryptography.KeyManagement.AzureKVKeyManager.EnsureRotatedKeyAsync()</a>.</p>

<p class="reference">Referenced by <a class="el" href="_library_8cs_source.html#l00041">Reina.Cryptography.Library.Encrypt()</a>, and <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00108">Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetDecryptionKeysAsync()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_a8cc7bef1fdb0aba8eb4bab50d5cbb023_cgraph.png" border="0" usemap="#aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_a8cc7bef1fdb0aba8eb4bab50d5cbb023_cgraph" alt=""/></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_a8cc7bef1fdb0aba8eb4bab50d5cbb023_icgraph.png" border="0" usemap="#aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_a8cc7bef1fdb0aba8eb4bab50d5cbb023_icgraph" alt=""/></div>
</div>

</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="a4dc18ecb50932bc8a02d7dedfcf946ee" name="a4dc18ecb50932bc8a02d7dedfcf946ee"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4dc18ecb50932bc8a02d7dedfcf946ee">&#9670;&#160;</a></span>_instance</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">readonly Lazy&lt;<a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html">AzureKVKeyManager</a>&gt; Reina.Cryptography.KeyManagement.AzureKVKeyManager._instance</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">= <span class="keyword">new</span>(() =&gt;</div>
<div class="line">        {</div>
<div class="line">            Config.Instance.ValidateConfiguration(); </div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code hl_function" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#af5aaf547ee232991879a67abc406a492">AzureKVKeyManager</a>(</div>
<div class="line">                Config.Instance.AzureKeyVaultUrl,</div>
<div class="line">                Config.Instance.AzureClientId,</div>
<div class="line">                Config.Instance.AzureClientSecret,</div>
<div class="line">                Config.Instance.AzureTenantId</div>
<div class="line">            );</div>
<div class="line">        })</div>
<div class="ttc" id="aclass_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager_html_af5aaf547ee232991879a67abc406a492"><div class="ttname"><a href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html#af5aaf547ee232991879a67abc406a492">Reina.Cryptography.KeyManagement.AzureKVKeyManager.AzureKVKeyManager</a></div><div class="ttdeci">AzureKVKeyManager(string vaultUri, string clientId, string clientSecret, string tenantId)</div><div class="ttdoc">Initializes a new instance of the AzureKVKeyManager class.</div><div class="ttdef"><b>Definition</b> <a href="_azure_k_v_key_manager_8cs_source.html#l00047">AzureKVKeyManager.cs:47</a></div></div>
</div><!-- fragment -->
<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00024">24</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>

</div>
</div>
<a id="aea9ba4e47b0fd2657081a1bc4767f73d" name="aea9ba4e47b0fd2657081a1bc4767f73d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aea9ba4e47b0fd2657081a1bc4767f73d">&#9670;&#160;</a></span>_keyCache</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">readonly ConcurrentDictionary&lt;string, byte[]&gt; Reina.Cryptography.KeyManagement.AzureKVKeyManager._keyCache = new()</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00021">21</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>

<p class="reference">Referenced by <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00108">Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetDecryptionKeysAsync()</a>, and <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00071">Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetEncryptionKeyAsync()</a>.</p>

</div>
</div>
<a id="a0f0d684424e6f369769493e5d9023cf3" name="a0f0d684424e6f369769493e5d9023cf3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0f0d684424e6f369769493e5d9023cf3">&#9670;&#160;</a></span>_secretClient</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">readonly SecretClient Reina.Cryptography.KeyManagement.AzureKVKeyManager._secretClient</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00020">20</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>

<p class="reference">Referenced by <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00047">Reina.Cryptography.KeyManagement.AzureKVKeyManager.AzureKVKeyManager()</a>, <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00191">Reina.Cryptography.KeyManagement.AzureKVKeyManager.EnsureRotatedKeyAsync()</a>, and <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00108">Reina.Cryptography.KeyManagement.AzureKVKeyManager.GetDecryptionKeysAsync()</a>.</p>

</div>
</div>
<h2 class="groupheader">Property Documentation</h2>
<a id="a01998e93a45999d7071c149fef32390f" name="a01998e93a45999d7071c149fef32390f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a01998e93a45999d7071c149fef32390f">&#9670;&#160;</a></span>Instance</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_reina_1_1_cryptography_1_1_key_management_1_1_azure_k_v_key_manager.html">AzureKVKeyManager</a> Reina.Cryptography.KeyManagement.AzureKVKeyManager.Instance</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span><span class="mlabel">get</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Gets the singleton instance of the AzureKVKeyManager. </p>

<p class="definition">Definition at line <a class="el" href="_azure_k_v_key_manager_8cs_source.html#l00038">38</a> of file <a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a>.</p>

<p class="reference">Referenced by <a class="el" href="_library_8cs_source.html#l00086">Reina.Cryptography.Library.Decrypt()</a>, and <a class="el" href="_library_8cs_source.html#l00041">Reina.Cryptography.Library.Encrypt()</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>KeyManagement/<a class="el" href="_azure_k_v_key_manager_8cs_source.html">AzureKVKeyManager.cs</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Jun 28 2025 19:50:03 for Reina.Cryptography by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
